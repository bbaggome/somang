## T-Bridge 데이터베이스 모델링 (SQL DDL)

본 문서는 `데이터베이스개요.md`에서 정의한 내용을 바탕으로, T-Bridge 서비스의 물리적 데이터베이스 스키마를 DDL(Data Definition Language)로 작성합니다.

- **대상 데이터베이스:** **PostgreSQL** (Supabase 호환)
- **특징:**
    - 모든 테이블과 컬럼에 영문 주석(COMMENT)을 추가했습니다.
    - Supabase의 보안 모델을 활용하기 위해 모든 테이블에 `ROW LEVEL SECURITY`를 활성화합니다.
    - 기본 키는 `uuid` 타입을 사용하며, `gen_random_uuid()` 함수로 자동 생성되도록 설정합니다.
    - 생성/수정 시각은 `timestamptz` 타입을 사용하여 명확한 시간 기록을 보장합니다.

---

### 0. Extensions
-- 지리 공간 쿼리 최적화를 위해 PostGIS 확장을 활성화합니다.
CREATE EXTENSION IF NOT EXISTS postgis WITH SCHEMA extensions;


### 1. `profiles` Table

애플리케이션 사용자의 역할 및 기본 정보를 관리합니다. Supabase의 `auth.users` 테이블과 연동됩니다.

```SQL
-- Table: profiles
CREATE TABLE public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    role text NOT NULL CHECK (role IN ('user', 'owner', 'admin')),
    name text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz
);

-- Comments
COMMENT ON TABLE public.profiles IS 'Stores public profile information for each user.';
COMMENT ON COLUMN public.profiles.id IS 'User ID, references auth.users.id.';
COMMENT ON COLUMN public.profiles.role IS 'User role: user, owner, or admin.';
COMMENT ON COLUMN public.profiles.name IS 'User''s display name or nickname.';
COMMENT ON COLUMN public.profiles.created_at IS 'Timestamp of when the profile was created.';
COMMENT ON COLUMN public.profiles.deleted_at IS 'Timestamp for soft deletion. If not null, the user is considered deleted.';

-- Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
```

### 2. `user_settings` Table

사용자별 알림 설정을 관리합니다.

```SQL
CREATE TABLE public.user_settings (
    user_id uuid NOT NULL PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
    chat_notification_enabled boolean NOT NULL DEFAULT true,
    promotion_notification_enabled boolean NOT NULL DEFAULT true,
    updated_at timestamptz DEFAULT now()
);

COMMENT ON TABLE public.user_settings IS 'Stores user-specific notification and other settings.';
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;
```


### 3. `stores` Table

플랫폼에 입점한 통신 판매점 정보를 관리합니다.

```SQL
-- Table: stores
CREATE TABLE public.stores (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE RESTRICT,
    name text NOT NULL,
    description text,
    profile_image_url text,
    zip_code text,
    base_address text,
    detail_address text,
    location geography(Point, 4326),
    status text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'suspended')),
    is_certified boolean NOT NULL DEFAULT false,
    response_rate numeric(5, 2) DEFAULT 0.00,
    chat_room_count integer DEFAULT 0,
    accepted_quote_count integer DEFAULT 0,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz
);

-- Indexes
-- 지리 공간 쿼리 성능 향상을 위한 GiST 인덱스 생성
CREATE INDEX stores_location_idx ON public.stores USING gist (location);

-- Comments
COMMENT ON TABLE public.stores IS 'Represents telecom retail stores registered on the platform.';
COMMENT ON COLUMN public.stores.id IS 'Unique identifier for the store.';
COMMENT ON COLUMN public.stores.owner_id IS 'The profile ID of the business owner.';
COMMENT ON COLUMN public.stores.name IS 'The name of the store.';
COMMENT ON COLUMN public.stores.description IS 'A brief introduction to the store.';
COMMENT ON COLUMN public.stores.profile_image_url IS 'URL for the store''s profile image.';
COMMENT ON COLUMN public.stores.location IS 'PostGIS geography type for location data (SRID 4326). Use a GiST index for efficient spatial queries.';
COMMENT ON COLUMN public.stores.status IS 'The current status of the store: pending, approved, rejected, suspended.';
COMMENT ON COLUMN public.stores.is_certified IS 'Flag for ''T-Bridge Certified Holy Land''.';
COMMENT ON COLUMN public.stores.response_rate IS 'Cache column for the store''s quote response rate. Maintained by database triggers.';
COMMENT ON COLUMN public.stores.chat_room_count IS 'Cache column for the total number of chats. Maintained by database triggers.';
COMMENT ON COLUMN public.stores.accepted_quote_count IS 'Cache column for the number of accepted quotes. Maintained by database triggers.';
COMMENT ON COLUMN public.stores.deleted_at IS 'Timestamp for soft deletion.';

-- Enable Row Level Security
ALTER TABLE public.stores ENABLE ROW LEVEL SECURITY;
```

### 4. `store_verification_documents` Table (New)

판매점 인증 서류를 관리합니다.

```SQL
CREATE TABLE public.store_verification_documents (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
    document_type text NOT NULL, -- e.g., 'business_license', 'telecom_license'
    file_url text NOT NULL,
    status text NOT NULL DEFAULT 'submitted' CHECK (status IN ('submitted', 'approved', 'rejected')),
    created_at timestamptz NOT NULL DEFAULT now(),
    reviewed_at timestamptz,
    reviewer_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
    reject_reason text
);

COMMENT ON TABLE public.store_verification_documents IS 'Stores documents for store verification.';
COMMENT ON COLUMN public.store_verification_documents.status IS 'Verification status of the document.';
COMMENT ON COLUMN public.store_verification_documents.reviewer_id IS 'The admin profile ID who reviewed the document.';
ALTER TABLE public.store_verification_documents ENABLE ROW LEVEL SECURITY;
```

### 5. `promotions` Table

판매점이 등록하는 마케팅 프로모션을 관리합니다.

```SQL
CREATE TABLE public.promotions (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
    title text NOT NULL,
    description text,
    start_date timestamptz NOT NULL,
    end_date timestamptz NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.promotions IS 'Stores promotional events created by stores.';
ALTER TABLE public.promotions ENABLE ROW LEVEL SECURITY;
```


### 6. `quote_requests` Table

사용자가 제출한 견적 요청서를 관리합니다.

```SQL
-- Table: quote_requests
CREATE TABLE public.quote_requests (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    product_type text NOT NULL CHECK (product_type IN ('mobile_phone', 'internet')),
    request_details jsonb NOT NULL,
    status text NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'closed', 'expired')),
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz
);

-- Comments
COMMENT ON TABLE public.quote_requests IS 'Stores quote requests submitted by users.';
COMMENT ON COLUMN public.quote_requests.request_details IS 'JSON object containing request details. Schema should be documented, e.g., { "model": "iPhone 17", "carrier": "SKT", "plan": "5G Unlimited" }.';
COMMENT ON COLUMN public.quote_requests.deleted_at IS 'Timestamp for soft deletion.';

-- Enable Row Level Security
ALTER TABLE public.quote_requests ENABLE ROW LEVEL SECURITY;
```

### 7. `quotes` Table

판매점이 사용자의 요청에 대해 제출한 표준 견적서 정보를 저장합니다.

```SQL
-- Table: quotes
CREATE TABLE public.quotes (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id uuid NOT NULL REFERENCES public.quote_requests(id) ON DELETE CASCADE,
    store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
    quote_details jsonb NOT NULL,
    status text NOT NULL DEFAULT 'sent' CHECK (status IN ('sent', 'viewed', 'accepted', 'rejected')),
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz
);

-- Comments
COMMENT ON TABLE public.quotes IS 'Stores standardized quotes submitted by stores in response to requests.';
COMMENT ON COLUMN public.quotes.quote_details IS 'JSON object with standardized quote details. Schema should be documented, e.g., { "devicePrice": 1500000, "subsidy": 500000, "storeSubsidy": 200000, "actualPrice": 800000, "monthlyFee": 89000 }.';
COMMENT ON COLUMN public.quotes.deleted_at IS 'Timestamp for soft deletion.';

-- Enable Row Level Security
ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
```

### 8. `reviews` Table

실거래 완료 후 사용자가 작성하는 리뷰와 별점을 관리합니다.

```SQL
-- Table: reviews
CREATE TABLE public.reviews (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE SET NULL,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE SET NULL,
    quote_id uuid NOT NULL UNIQUE REFERENCES public.quotes(id) ON DELETE RESTRICT,
    rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment text,
    is_hidden boolean NOT NULL DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now(),
    deleted_at timestamptz
);

-- Comments
COMMENT ON TABLE public.reviews IS 'Stores reviews and ratings submitted by users after a transaction.';
COMMENT ON COLUMN public.reviews.quote_id IS 'The transaction (quote) this review is for. Ensures one review per transaction.';
COMMENT ON COLUMN public.reviews.deleted_at IS 'Timestamp for soft deletion.';

-- Enable Row Level Security
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;
```

### 9. `review_votes` Table

리뷰에 대한 '좋아요/싫어요' 반응을 기록합니다.

```SQL
CREATE TABLE public.review_votes (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    review_id uuid NOT NULL REFERENCES public.reviews(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    vote_type text NOT NULL CHECK (vote_type IN ('like', 'dislike')),
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE (review_id, user_id)
);

COMMENT ON TABLE public.review_votes IS 'Stores likes and dislikes for reviews.';
ALTER TABLE public.review_votes ENABLE ROW LEVEL SECURITY;
```

### 10. `favorites` Table

사용자가 찜한 판매점 정보를 관리합니다.

```SQL
CREATE TABLE public.favorites (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    target_id uuid NOT NULL, -- The ID of the item being favorited, e.g., a store's ID
    target_type text NOT NULL CHECK (target_type IN ('STORE')), -- Can be extended to 'PHONE_MODEL' etc.
    created_at timestamptz NOT NULL DEFAULT now(),
    UNIQUE(user_id, target_id, target_type)
);

COMMENT ON TABLE public.favorites IS 'Stores user''s bookmarked items like stores.';
ALTER TABLE public.favorites ENABLE ROW LEVEL SECURITY;
```

### 11. `chat_rooms` & `chat_messages` Tables

소비자와 판매점 간의 1:1 보안 채팅 기능을 구현합니다.

```SQL
-- Table: chat_rooms
CREATE TABLE public.chat_rooms (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
    quote_id uuid REFERENCES public.quotes(id) ON DELETE SET NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT unique_chat_per_context UNIQUE (user_id, store_id, quote_id)
);

COMMENT ON TABLE public.chat_rooms IS 'Represents a private chat room between a user and a store.';
ALTER TABLE public.chat_rooms ENABLE ROW LEVEL SECURITY;

-- Table: chat_messages
CREATE TABLE public.chat_messages (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id uuid NOT NULL REFERENCES public.chat_rooms(id) ON DELETE CASCADE,
    sender_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    content text NOT NULL,
    message_type text NOT NULL DEFAULT 'text' CHECK (message_type IN ('text', 'image')),
    attachment_url text,
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.chat_messages IS 'Stores all messages sent within chat rooms.';
ALTER TABLE public.chat_messages ENABLE ROW LEVEL SECURITY;
```

### 12. `notices` Table

플랫폼 전체 공지사항을 관리합니다.

```SQL
CREATE TABLE public.notices (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
    title text NOT NULL,
    content text NOT NULL,
    is_published boolean NOT NULL DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.notices IS 'Stores platform-wide announcements for users.';
ALTER TABLE public.notices ENABLE ROW LEVEL SECURITY;
```

### 13. `policies` & `policy_consents` Tables

버전이 관리되는 서비스 약관과 사용자 동의 이력을 관리합니다.

```SQL
CREATE TABLE public.policies (
    id serial PRIMARY KEY,
    policy_type text NOT NULL, -- e.g., 'terms_of_service', 'privacy_policy'
    version text NOT NULL,
    content text NOT NULL,
    effective_date date NOT NULL,
    created_at timestamptz DEFAULT now(),
    UNIQUE(policy_type, version)
);

COMMENT ON TABLE public.policies IS 'Stores versioned legal documents like ToS and Privacy Policy.';
ALTER TABLE public.policies ENABLE ROW LEVEL SECURITY;

CREATE TABLE public.policy_consents (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    policy_id integer NOT NULL REFERENCES public.policies(id) ON DELETE RESTRICT,
    consent_date timestamptz NOT NULL DEFAULT now(),
    UNIQUE(user_id, policy_id)
);

COMMENT ON TABLE public.policy_consents IS 'Tracks user consent to specific policy versions.';
ALTER TABLE public.policy_consents ENABLE ROW LEVEL SECURITY;
```

### 14. `support_tickets` & `ticket_replies` Tables

고객 지원 문의 및 답변을 관리합니다.

```SQL
CREATE TABLE public.support_tickets (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    title text NOT NULL,
    content text NOT NULL,
    status text NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'closed')),
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.support_tickets IS 'Stores customer support inquiries.';
ALTER TABLE public.support_tickets ENABLE ROW LEVEL SECURITY;

CREATE TABLE public.ticket_replies (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    ticket_id uuid NOT NULL REFERENCES public.support_tickets(id) ON DELETE CASCADE,
    replier_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    content text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.ticket_replies IS 'Stores replies for support tickets.';
ALTER TABLE public.ticket_replies ENABLE ROW LEVEL SECURITY;
```

### 15. `audit_logs` Table (New)

플랫폼의 주요 변경 이력을 기록하는 감사 로그 테이블입니다.

```SQL
CREATE TABLE public.audit_logs (
    id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
    actor_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
    action_type text NOT NULL,
    target_id uuid,
    old_value jsonb,
    new_value jsonb,
    created_at timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE public.audit_logs IS 'Stores audit trails for significant actions within the platform.';
COMMENT ON COLUMN public.audit_logs.actor_id IS 'The ID of the user or admin who performed the action.';
COMMENT ON COLUMN public.audit_logs.action_type IS 'The type of action performed (e.g., ''STORE_APPROVED'', ''USER_SUSPENDED'').';
COMMENT ON COLUMN public.audit_logs.target_id IS 'The ID of the resource that was affected.';
COMMENT ON COLUMN public.audit_logs.old_value IS 'The state of the data before the change.';
COMMENT ON COLUMN public.audit_logs.new_value IS 'The state of the data after the change.';

ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;
```