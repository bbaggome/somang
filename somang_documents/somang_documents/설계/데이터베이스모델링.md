## T-Bridge 데이터베이스 모델링 (SQL DDL)

본 문서는 `데이터베이스개요.md`에서 정의한 내용을 바탕으로, T-Bridge 서비스의 물리적 데이터베이스 스키마를 DDL(Data Definition Language)로 작성합니다.

- **대상 데이터베이스:** **PostgreSQL** (Supabase 호환)
- **특징:**
    - 모든 테이블과 컬럼에 영문 주석(COMMENT)을 추가했습니다.
    - Supabase의 보안 모델을 활용하기 위해 모든 테이블에 `ROW LEVEL SECURITY`를 활성화합니다.
    - 기본 키는 `uuid` 타입을 사용하며, `gen_random_uuid()` 함수로 자동 생성되도록 설정합니다.
    - 생성/수정 시각은 `timestamptz` 타입을 사용하여 명확한 시간 기록을 보장합니다.

---

### 1. `profiles` Table

애플리케이션 사용자의 역할 및 기본 정보를 관리합니다. Supabase의 `auth.users` 테이블과 연동됩니다.

```sql
-- Table: profiles
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  role text NOT NULL CHECK (role IN ('user', 'owner', 'admin')),
  name text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.profiles IS 'Stores public profile information for each user.';
COMMENT ON COLUMN public.profiles.id IS 'User ID, references auth.users.id.';
COMMENT ON COLUMN public.profiles.role IS 'User role: user, owner, or admin.';
COMMENT ON COLUMN public.profiles.name IS 'User''s display name or nickname.';
COMMENT ON COLUMN public.profiles.created_at IS 'Timestamp of when the profile was created.';

-- Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
```

### 2. `stores` Table

플랫폼에 입점한 통신 판매점 정보를 관리합니다.

```sql
-- Table: stores
CREATE TABLE public.stores (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  name text NOT NULL,
  address text,
  description text,
  profile_image_url text,
  is_certified boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.stores IS 'Represents telecom retail stores registered on the platform.';
COMMENT ON COLUMN public.stores.id IS 'Unique identifier for the store.';
COMMENT ON COLUMN public.stores.owner_id IS 'The profile ID of the business owner.';
COMMENT ON COLUMN public.stores.name IS 'The name of the store.';
COMMENT ON COLUMN public.stores.address IS 'The physical address of the store.';
COMMENT ON COLUMN public.stores.description IS 'A brief introduction to the store.';
COMMENT ON COLUMN public.stores.profile_image_url IS 'URL for the store''s profile image.';
COMMENT ON COLUMN public.stores.is_certified IS 'Flag for ''T-Bridge Certified Holy Land''.';
COMMENT ON COLUMN public.stores.created_at IS 'Timestamp of when the store was registered.';

-- Enable Row Level Security
ALTER TABLE public.stores ENABLE ROW LEVEL SECURITY;
```

### 3. `quote_requests` Table

사용자가 제출한 견적 요청서를 관리합니다.

```sql
-- Table: quote_requests
CREATE TABLE public.quote_requests (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  product_type text NOT NULL CHECK (product_type IN ('mobile_phone', 'internet')),
  request_details jsonb NOT NULL,
  status text NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'closed', 'expired')),
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.quote_requests IS 'Stores quote requests submitted by users.';
COMMENT ON COLUMN public.quote_requests.id IS 'Unique identifier for the quote request.';
COMMENT ON COLUMN public.quote_requests.user_id IS 'The ID of the user who made the request.';
COMMENT ON COLUMN public.quote_requests.product_type IS 'Type of product requested: mobile_phone or internet.';
COMMENT ON COLUMN public.quote_requests.request_details IS 'JSON object containing request details (e.g., phone model, plan).';
COMMENT ON COLUMN public.quote_requests.status IS 'The current status of the request: open, closed, or expired.';
COMMENT ON COLUMN public.quote_requests.created_at IS 'Timestamp of when the request was created.';

-- Enable Row Level Security
ALTER TABLE public.quote_requests ENABLE ROW LEVEL SECURITY;
```

### 4. `quotes` Table

판매점이 사용자의 요청에 대해 제출한 표준 견적서 정보를 저장합니다.

```sql
-- Table: quotes
CREATE TABLE public.quotes (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id uuid NOT NULL REFERENCES public.quote_requests(id) ON DELETE CASCADE,
  store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
  quote_details jsonb NOT NULL,
  status text NOT NULL DEFAULT 'sent' CHECK (status IN ('sent', 'viewed', 'accepted', 'rejected')),
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.quotes IS 'Stores standardized quotes submitted by stores in response to requests.';
COMMENT ON COLUMN public.quotes.id IS 'Unique identifier for the quote.';
COMMENT ON COLUMN public.quotes.request_id IS 'The request this quote is for.';
COMMENT ON COLUMN public.quotes.store_id IS 'The store that submitted this quote.';
COMMENT ON COLUMN public.quotes.quote_details IS 'JSON object with standardized quote details (e.g., price, TCO).';
COMMENT ON COLUMN public.quotes.status IS 'The status of the quote: sent, viewed, accepted, or rejected.';
COMMENT ON COLUMN public.quotes.created_at IS 'Timestamp of when the quote was submitted.';

-- Enable Row Level Security
ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
```

### 5. `reviews` Table

실거래 완료 후 사용자가 작성하는 리뷰와 별점을 관리합니다.

```sql
-- Table: reviews
CREATE TABLE public.reviews (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  quote_id uuid NOT NULL UNIQUE REFERENCES public.quotes(id) ON DELETE CASCADE,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.reviews IS 'Stores reviews and ratings submitted by users after a transaction.';
COMMENT ON COLUMN public.reviews.id IS 'Unique identifier for the review.';
COMMENT ON COLUMN public.reviews.store_id IS 'The ID of the store being reviewed.';
COMMENT ON COLUMN public.reviews.user_id IS 'The ID of the user who wrote the review.';
COMMENT ON COLUMN public.reviews.quote_id IS 'The transaction (quote) this review is for. Ensures one review per transaction.';
COMMENT ON COLUMN public.reviews.rating IS 'Star rating from 1 to 5.';
COMMENT ON COLUMN public.reviews.comment IS 'The text content of the review.';
COMMENT ON COLUMN public.reviews.created_at IS 'Timestamp of when the review was submitted.';

-- Enable Row Level Security
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;
```

### 6. `chat_rooms` and `chat_messages` Tables

소비자와 판매점 간의 1:1 보안 채팅 기능을 구현합니다.

```sql
-- Table: chat_rooms
CREATE TABLE public.chat_rooms (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  store_id uuid NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
  quote_id uuid REFERENCES public.quotes(id) ON DELETE SET NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT unique_chat_per_context UNIQUE (user_id, store_id, quote_id)
);

-- Comments
COMMENT ON TABLE public.chat_rooms IS 'Represents a private chat room between a user and a store.';
COMMENT ON COLUMN public.chat_rooms.id IS 'Unique identifier for the chat room.';
COMMENT ON COLUMN public.chat_rooms.user_id IS 'The user participating in the chat.';
COMMENT ON COLUMN public.chat_rooms.store_id IS 'The store participating in the chat.';
COMMENT ON COLUMN public.chat_rooms.quote_id IS 'The quote that initiated this chat, if any.';
COMMENT ON COLUMN public.chat_rooms.created_at IS 'Timestamp of when the chat room was created.';

-- Enable Row Level Security
ALTER TABLE public.chat_rooms ENABLE ROW LEVEL SECURITY;

-- Table: chat_messages
CREATE TABLE public.chat_messages (
  id uuid NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id uuid NOT NULL REFERENCES public.chat_rooms(id) ON DELETE CASCADE,
  sender_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  content text NOT NULL,
  created_at timestam_ptz NOT NULL DEFAULT now()
);

-- Comments
COMMENT ON TABLE public.chat_messages IS 'Stores all messages sent within chat rooms.';
COMMENT ON COLUMN public.chat_messages.id IS 'Unique identifier for the message.';
COMMENT ON COLUMN public.chat_messages.room_id IS 'The room this message belongs to.';
COMMENT ON COLUMN public.chat_messages.sender_id IS 'The profile ID of the message sender.';
COMMENT ON COLUMN public.chat_messages.content IS 'The text content of the message.';
COMMENT ON COLUMN public.chat_messages.created_at IS 'Timestamp of when the message was sent.';

-- Enable Row Level Security
ALTER TABLE public.chat_messages ENABLE ROW LEVEL SECURITY;
```