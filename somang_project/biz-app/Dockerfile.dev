# 1. Base Image: Node.js 20 버전을 기반으로 이미지를 생성합니다.
FROM node:22.17.0

# ======== 시스템 의존성 설치 추가 ========
# next/font 및 다른 패키지들이 필요로 하는 네이티브 모듈을 빌드하기 위해
# 필요한 시스템 라이브러리들을 설치합니다.
RUN apt-get update && apt-get install -y build-essential libcairo2-dev \
    libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

# 2. 작업 디렉토리 설정
WORKDIR /app

# 3. pnpm을 전역으로 설치합니다.
RUN npm install -g pnpm

# 4. 의존성 설치를 위해 package.json 파일을 먼저 복사합니다.
COPY package.json pnpm-lock.yaml ./

# 5. 의존성을 설치합니다.
RUN pnpm install

# 6. 나머지 소스 코드를 복사합니다.
COPY . .

# 애플리케이션 실행 포트 노출 (HTTP와 HTTPS 모두)
EXPOSE 50332 50444

# 7. 앱을 실행할 기본 명령어를 설정합니다.
# Docker 환경에서는 항상 HTTPS로 실행
CMD ["pnpm", "run", "dev:docker"]
