<!DOCTYPE html>
<html>
<head>
    <title>Firebase FCM ì›¹ í…ŒìŠ¤íŠ¸</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
</head>
<body>
    <h1>ğŸ”¥ Firebase FCM ì›¹ í…ŒìŠ¤íŠ¸</h1>
    <div id="token-display">FCM í† í° ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
    <button id="test-notification" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;" disabled>
        FCM í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°
    </button>
    <div id="result" style="margin-top: 20px; padding: 10px; background: #f0f0f0;"></div>

    <script>
        // Firebase êµ¬ì„±
        const firebaseConfig = {
            apiKey: "AIzaSyCdh-JVwPW_ZGOJl_vBH6rDMWl-wJcxFU8",
            authDomain: "t-bridge.firebaseapp.com",
            projectId: "t-bridge",
            storageBucket: "t-bridge.firebasestorage.app",
            messagingSenderId: "896375537648",
            appId: "1:896375537648:web:7d0f83d12dd2c7f9cbbc63"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        
        const messaging = firebase.messaging();
        let currentToken = null;

        // ì•Œë¦¼ ê¶Œí•œ ë¨¼ì € í™•ì¸ í›„ í† í° ê°€ì ¸ì˜¤ê¸°
        async function getFCMToken() {
            try {
                // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
                const permission = await Notification.requestPermission();
                console.log('ì•Œë¦¼ ê¶Œí•œ ê²°ê³¼:', permission);
                
                if (permission !== 'granted') {
                    document.getElementById('token-display').innerText = 'âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    return;
                }

                // FCM í† í° ê°€ì ¸ì˜¤ê¸° (VAPID í‚¤ ì—†ì´ ì‹œë„)
                console.log('FCM í† í° ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
                const currentToken = await messaging.getToken();
                console.log('FCM í† í° ê²°ê³¼:', currentToken);
                
                if (currentToken) {
                    console.log('âœ… FCM í† í° íšë“ ì„±ê³µ:', currentToken);
                    document.getElementById('token-display').innerHTML = 
                        `<strong>FCM í† í°:</strong><br><textarea style="width:100%; height:100px; font-size:12px;">${currentToken}</textarea>`;
                    document.getElementById('test-notification').disabled = false;
                    window.fcmToken = currentToken;
                } else {
                    console.log('âŒ FCM í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('token-display').innerHTML = 
                        `<div style="color: orange;">âš ï¸ FCM í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        HTTPS í™˜ê²½ì´ ì•„ë‹ˆê±°ë‚˜ Service Worker ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button></div>`;
                }
            } catch (err) {
                console.error('FCM í† í° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', err);
                document.getElementById('token-display').innerHTML = 
                    `<div style="color: red;">âŒ FCM í† í° ì˜¤ë¥˜: ${err.message}<br>
                    <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button></div>`;
            }
        }

        // í•¨ìˆ˜ í˜¸ì¶œ
        getFCMToken();

        // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
        messaging.onMessage((payload) => {
            console.log('í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);
            
            document.getElementById('result').innerHTML += 
                `<div style="border: 1px solid green; margin: 5px 0; padding: 10px;">
                    <strong>âœ… ì•Œë¦¼ ìˆ˜ì‹ :</strong><br>
                    ì œëª©: ${payload.notification.title}<br>
                    ë‚´ìš©: ${payload.notification.body}<br>
                    ì‹œê°„: ${new Date().toLocaleString()}
                </div>`;
        });

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°
        document.getElementById('test-notification').addEventListener('click', async () => {
            if (!window.fcmToken) {
                alert('FCM í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('result').innerHTML = 'ğŸ“¤ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡ ì¤‘...';

            try {
                const response = await fetch('https://bbxycbghbatcovzuiotu.supabase.co/functions/v1/send-firebase-fcm-notification', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJieHljYmdoYmF0Y292enVpb3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyMDEwOTYsImV4cCI6MjA2NTc3NzA5Nn0.dvG6EzASvCOWQZ0AEHMseTV7WvgOnHNkt58NAviW5is',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fcm_tokens: [window.fcmToken],
                        notification: {
                            title: 'ğŸ‰ T-Bridge FCM í…ŒìŠ¤íŠ¸ ì„±ê³µ!',
                            body: 'Firebase FCM HTTP v1 APIê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!',
                            image: 'https://firebase.google.com/images/brand-guidelines/logo-standard.png'
                        },
                        data: {
                            type: 'test_notification',
                            source: 'web_test',
                            timestamp: Date.now().toString()
                        }
                    })
                });

                const result = await response.json();
                console.log('FCM ë°œì†¡ ê²°ê³¼:', result);

                document.getElementById('result').innerHTML = 
                    `<div style="border: 1px solid blue; padding: 10px; margin: 10px 0;">
                        <strong>ğŸ“Š ë°œì†¡ ê²°ê³¼:</strong><br>
                        ì„±ê³µ: ${result.sent || 0}ê°œ<br>
                        ì‹¤íŒ¨: ${result.failed || 0}ê°œ<br>
                        ì„œë¹„ìŠ¤: ${result.service}<br>
                        ì‹œê°„: ${new Date().toLocaleString()}
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;

            } catch (error) {
                console.error('FCM í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                document.getElementById('result').innerHTML = 
                    `<div style="border: 1px solid red; padding: 10px; color: red;">
                        âŒ ì˜¤ë¥˜: ${error.message}
                    </div>`;
            }
        });

        // ì•Œë¦¼ ê¶Œí•œì€ getFCMToken() í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë¨
    </script>
</body>
</html>